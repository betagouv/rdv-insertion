<div class="d-flex justify-content-center">
  <table class="card-white text-center align-middle m-3 shadow-sm">
    <thead>
      <tr>
        <% if show_invitation?("sms", invitation_formats) %>
          <th class="px-4 py-3">
            <h4>Invitation SMS</h4>
          </th>
        <% end %>
        <% if show_invitation?("email", invitation_formats) %>
          <th class="px-4 py-3">
            <h4>Invitation mail</h4>
          </th>
        <% end %>
        <% if show_invitation?("postal", invitation_formats) %>
          <th class="px-4 py-3">
            <h4>Invitation courrier</h4>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% invitation_dates_by_format = invitation_dates_by_format(invitations, invitation_formats) %>
      <% invitation_dates_by_format.values.map(&:length).max.times do |idx| %>
        <tr>
          <% invitation_formats.map do |format| %>
            <td class="px-4 py-3">
              <%= format_date(invitation_dates_by_format[format]&.fetch(idx, nil)) %>
            </td>
          <% end %>
        </tr>
      <% end %>
      <tr>
        <% if show_invitation?("sms", invitation_formats) %>
          <% invitation_disabled = !user.phone_number_is_mobile? || user.archived_in?(department) || follow_up.rdv_pending? || follow_up.closed? %>
          <td class="px-4 py-3">
            <%= form_for :invitation, url: structure_user_invitations_path(user.id), html: { method: :post } do |f| %>
              <%= f.hidden_field :format, value: "sms" %>
              <%= f.fields_for :motif_category do |ff| %>
                <%= ff.hidden_field :id, value: motif_category.id %>
              <% end %>
              <button
                data-controller="invitation-button"
                data-action="click->invitation-button#setAsPending"
                class="btn btn-blue<%= invitation_disabled ? ' disabled' : '' %>"
                type="submit"
              >
                <% if invitations.any?(&:format_sms?) %>
                  <span
                    data-controller="tooltip"
                    data-action="mouseover->tooltip#reinviteButton"
                  >
                    Réinviter
                  </span>
                <% else %>
                  Inviter
                <% end %>
              </button>
            <% end %>
          </td>
        <% end %>
        <% if show_invitation?("email", invitation_formats) %>
          <% invitation_disabled = !user.email? || user.archived_in?(department) || follow_up.rdv_pending? || follow_up.closed? %>
          <td class="px-4 py-3">
            <%= form_for :invitation, url: structure_user_invitations_path(user.id), html: { method: :post } do |f| %>
              <%= f.hidden_field :format, value: "email" %>
              <%= f.fields_for :motif_category do |ff| %>
                <%= ff.hidden_field :id, value: motif_category.id %>
              <% end %>
              <button
                data-controller="invitation-button"
                data-action="click->invitation-button#setAsPending"
                class="btn btn-blue<%= invitation_disabled ? ' disabled' : '' %>"
                type="submit"
              >
                <% if invitations.any?(&:format_email?) %>
                  <span
                    data-controller="tooltip"
                    data-action="mouseover->tooltip#reinviteButton"
                  >
                    Réinviter
                  </span>
                <% else %>
                  Inviter
                <% end %>
              </button>
            <% end %>
          </td>
        <% end %>
        <% if show_invitation?("postal", invitation_formats) %>
          <% invitation_disabled = !user.address.present? || user.archived_in?(department) || follow_up.rdv_pending? || follow_up.closed?  %>
          <td class="px-4 py-3">
            <%= form_for :invitation, url: structure_user_invitations_path(user.id, format: "pdf"), html: { method: :post } do |f| %>
              <%= f.hidden_field :format, value: "postal" %>
              <%= f.fields_for :motif_category do |ff| %>
                <%= ff.hidden_field :id, value: motif_category.id %>
              <% end %>

              <button
                data-controller="invitation-button"
                data-action="click->invitation-button#setAsPending"
                class="btn btn-blue<%= invitation_disabled ? ' disabled' : '' %>"
                type="submit"
              >
                <% if invitations.any?(&:format_postal?) %>
                  <span
                    data-controller="tooltip"
                    data-action="mouseover->tooltip#reinviteButton"
                  >
                    Réinviter
                  </span>
                <% else %>
                  Inviter
                <% end %>
              </button>
            <% end %>
          </td>
        <% end %>
      </tr>
      <%# {showInvitationsHistoryButton && (
        <tr>
          <td class="px-4 py-2" colSpan={3} style={{ cursor: "pointer" }}>
            {!showInvitationsHistory && (
              <button onClick={handleShowInvitationsHistory} type="button">
                <i class="fas fa-angle-down" /> Voir l&apos;historique{" "}
                <i class="fas fa-angle-down" />
              </button>
            )}
            {showInvitationsHistory && (
              <button onClick={handleHideInvitationsHistory} type="button">
                <i class="fas fa-angle-up" /> Voir moins <i class="fas fa-angle-up" />
              </button>
            )}
          </td>
        </tr>
      )} %>
    </tbody>
  </table>
</div>
